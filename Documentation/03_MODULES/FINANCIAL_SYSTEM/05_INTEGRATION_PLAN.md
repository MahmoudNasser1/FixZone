# Ø®Ø·Ø© Ø§Ù„ØªÙƒØ§Ù…Ù„ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©
## Financial System - Integration Plan

**ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:** 2025-01-27  
**Ø§Ù„Ø­Ø§Ù„Ø©:** Production System - Ø®Ø·Ø© ØªÙƒØ§Ù…Ù„ Ø´Ø§Ù…Ù„Ø©  
**Ø§Ù„Ø¥ØµØ¯Ø§Ø±:** 1.0.0

---

## ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª

1. [Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒØ§Ù…Ù„](#1-Ù†Ø¸Ø±Ø©-Ø¹Ø§Ù…Ø©-Ø¹Ù„Ù‰-Ø§Ù„ØªÙƒØ§Ù…Ù„)
2. [Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Repairs Module](#2-Ø§Ù„ØªÙƒØ§Ù…Ù„-Ù…Ø¹-repairs-module)
3. [Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Inventory Module](#3-Ø§Ù„ØªÙƒØ§Ù…Ù„-Ù…Ø¹-inventory-module)
4. [Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Customers Module](#4-Ø§Ù„ØªÙƒØ§Ù…Ù„-Ù…Ø¹-customers-module)
5. [Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Companies Module](#5-Ø§Ù„ØªÙƒØ§Ù…Ù„-Ù…Ø¹-companies-module)
6. [Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Branches Module](#6-Ø§Ù„ØªÙƒØ§Ù…Ù„-Ù…Ø¹-branches-module)
7. [Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Users Module](#7-Ø§Ù„ØªÙƒØ§Ù…Ù„-Ù…Ø¹-users-module)
8. [Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Notifications Module](#8-Ø§Ù„ØªÙƒØ§Ù…Ù„-Ù…Ø¹-notifications-module)
9. [Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Reports Module](#9-Ø§Ù„ØªÙƒØ§Ù…Ù„-Ù…Ø¹-reports-module)

---

## 1. Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒØ§Ù…Ù„

### 1.1 Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØµÙ„Ø©

| Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„ | Ù†ÙˆØ¹ Ø§Ù„ØªÙƒØ§Ù…Ù„ | Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© | Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© |
|---------|------------|---------------|----------------|
| Repairs | Ù…Ø¨Ø§Ø´Ø± | âš ï¸ Ø¬Ø²Ø¦ÙŠ | âœ… ÙƒØ§Ù…Ù„ |
| Inventory | Ù…Ø¨Ø§Ø´Ø± | âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ | âœ… ÙƒØ§Ù…Ù„ |
| Customers | Ù…Ø¨Ø§Ø´Ø± | âš ï¸ Ø¬Ø²Ø¦ÙŠ | âœ… ÙƒØ§Ù…Ù„ |
| Companies | Ù…Ø¨Ø§Ø´Ø± | âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ | âœ… ÙƒØ§Ù…Ù„ |
| Branches | Ù…Ø¨Ø§Ø´Ø± | âš ï¸ Ø¬Ø²Ø¦ÙŠ | âœ… ÙƒØ§Ù…Ù„ |
| Users | Ù…Ø¨Ø§Ø´Ø± | âœ… Ù…ÙˆØ¬ÙˆØ¯ | âœ… Ù…Ø­Ø³Ù‘Ù† |
| Notifications | ØºÙŠØ± Ù…Ø¨Ø§Ø´Ø± | âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ | âœ… ÙƒØ§Ù…Ù„ |
| Reports | ØºÙŠØ± Ù…Ø¨Ø§Ø´Ø± | âš ï¸ Ø¬Ø²Ø¦ÙŠ | âœ… ÙƒØ§Ù…Ù„ |

### 1.2 Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªÙƒØ§Ù…Ù„

1. **Database Level Integration**
   - Foreign Keys
   - Triggers
   - Stored Procedures

2. **Application Level Integration**
   - Service Layer
   - Event Emitters
   - WebSocket Events

3. **API Level Integration**
   - RESTful APIs
   - Webhooks
   - Real-time Sync

---

## 2. Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Repairs Module

### 2.1 Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ

**Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯:**
- âœ… `Invoice.repairRequestId` - Ø±Ø¨Ø· Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¨Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­
- âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†Ø·Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
- âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø­Ø§Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ø¥ØµÙ„Ø§Ø­

### 2.2 Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨

#### 2.2.1 Database Schema

```sql
-- Invoice table already has repairRequestId
-- Add index for better performance
CREATE INDEX idx_invoice_repair ON Invoice(repairRequestId);

-- Add trigger to update repair status when invoice is paid
DELIMITER $$
CREATE TRIGGER update_repair_on_invoice_paid
AFTER UPDATE ON Invoice
FOR EACH ROW
BEGIN
  IF NEW.status = 'paid' AND OLD.status != 'paid' THEN
    UPDATE RepairRequest
    SET status = 'completed',
        invoiceId = NEW.id,
        completedAt = NOW()
    WHERE id = NEW.repairRequestId;
  END IF;
END$$
DELIMITER ;
```

#### 2.2.2 Service Integration

```javascript
// backend/services/financial/invoices.service.js

async createFromRepair(repairId, data, user) {
  // Get repair request
  const repair = await repairsService.getById(repairId, user);
  
  // Validate repair can be invoiced
  if (repair.status !== 'ready_for_invoice') {
    throw new Error('Repair is not ready for invoicing');
  }

  // Generate invoice items from repair
  const items = await this.generateItemsFromRepair(repair);

  // Create invoice
  const invoice = await this.create({
    ...data,
    repairRequestId: repairId,
    customerId: repair.customerId,
    items
  }, user);

  // Update repair status
  await repairsService.updateStatus(repairId, 'invoiced', user);

  // Emit event
  this.emitEvent('invoice_created_from_repair', {
    repairId,
    invoiceId: invoice.id
  });

  return invoice;
}

async generateItemsFromRepair(repair) {
  const items = [];

  // Add services
  if (repair.services && repair.services.length > 0) {
    for (const service of repair.services) {
      items.push({
        serviceId: service.id,
        description: service.name,
        quantity: 1,
        unitPrice: service.price
      });
    }
  }

  // Add accessories
  if (repair.accessories && repair.accessories.length > 0) {
    for (const accessory of repair.accessories) {
      items.push({
        inventoryItemId: accessory.inventoryItemId,
        description: accessory.name,
        quantity: accessory.quantity,
        unitPrice: accessory.unitPrice
      });
    }
  }

  // Add labor cost
  if (repair.laborCost > 0) {
    items.push({
      description: 'ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù…Ø§Ù„Ø©',
      quantity: 1,
      unitPrice: repair.laborCost
    });
  }

  return items;
}
```

#### 2.2.3 WebSocket Events

```javascript
// When invoice is created from repair
socket.emit('repair:invoice_created', {
  repairId: 10,
  invoiceId: 5
});

// When invoice is paid
socket.emit('repair:invoice_paid', {
  repairId: 10,
  invoiceId: 5
});
```

### 2.3 API Endpoints

```javascript
// Create invoice from repair
POST /api/financial/invoices/create-from-repair/:repairId

// Get invoice by repair
GET /api/financial/invoices/by-repair/:repairId

// Get repair invoices
GET /api/repairs/:repairId/invoices
```

---

## 3. Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Inventory Module

### 3.1 Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ

**Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯:**
- âœ… `InvoiceItem.inventoryItemId` - Ø±Ø¨Ø· Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
- âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®ØµÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
- âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¨Ø· Ø¨ÙŠÙ† Ø§Ù„Ù†ÙÙ‚Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†

### 3.2 Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨

#### 3.2.1 Database Schema

```sql
-- InvoiceItem already has inventoryItemId
-- Add index
CREATE INDEX idx_invoice_item_inventory ON InvoiceItem(inventoryItemId);

-- Add trigger to deduct stock when invoice is paid
DELIMITER $$
CREATE TRIGGER deduct_stock_on_invoice_paid
AFTER UPDATE ON Invoice
FOR EACH ROW
BEGIN
  IF NEW.status = 'paid' AND OLD.status != 'paid' THEN
    -- Deduct stock for all invoice items
    UPDATE InventoryItem ii
    INNER JOIN InvoiceItem inv_item ON ii.id = inv_item.inventoryItemId
    SET ii.stockLevel = ii.stockLevel - inv_item.quantity,
        ii.updatedAt = NOW()
    WHERE inv_item.invoiceId = NEW.id
      AND inv_item.inventoryItemId IS NOT NULL;
  END IF;
END$$
DELIMITER ;
```

#### 3.2.2 Service Integration

```javascript
// backend/services/financial/invoices.service.js

async markAsPaid(invoiceId, user) {
  const invoice = await this.getById(invoiceId, user);
  
  // Update invoice status
  await invoicesRepository.update(invoiceId, { status: 'paid' });

  // Deduct inventory stock
  const items = await invoiceItemsService.getByInvoice(invoiceId);
  for (const item of items) {
    if (item.inventoryItemId) {
      await inventoryService.deductStock(
        item.inventoryItemId,
        item.quantity,
        `Invoice ${invoice.invoiceNumber}`
      );
    }
  }

  // Emit event
  this.emitEvent('invoice_paid', {
    invoiceId,
    items: items.filter(i => i.inventoryItemId)
  });

  return invoice;
}
```

#### 3.2.3 Expense Integration with Inventory

```javascript
// backend/services/financial/expenses.service.js

async create(data, user) {
  // Create expense
  const expense = await expensesRepository.create({
    ...data,
    createdBy: user.id
  });

  // If linked to inventory item, update stock
  if (data.inventoryItemId && data.quantity) {
    await inventoryService.addStock(
      data.inventoryItemId,
      data.quantity,
      `Expense ${expense.id}`
    );
  }

  return expense;
}
```

---

## 4. Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Customers Module

### 4.1 Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ

**Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯:**
- âš ï¸ Ø±Ø¨Ø· ØºÙŠØ± Ù…Ø¨Ø§Ø´Ø± Ø¹Ø¨Ø± `RepairRequest.customerId`
- âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± `Invoice.customerId`
- âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù„Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ­Ù‚

### 4.2 Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨

#### 4.2.1 Database Schema

```sql
-- Add customerId to Invoice
ALTER TABLE Invoice
  ADD COLUMN customerId INT(11) NULL AFTER id,
  ADD INDEX idx_invoice_customer (customerId),
  ADD FOREIGN KEY (customerId) REFERENCES Customer(id) ON DELETE SET NULL;

-- Create view for customer balance
CREATE VIEW CustomerBalance AS
SELECT 
  c.id as customerId,
  c.name as customerName,
  COALESCE(SUM(i.totalAmount), 0) as totalInvoiced,
  COALESCE(SUM(p.amount), 0) as totalPaid,
  COALESCE(SUM(i.totalAmount), 0) - COALESCE(SUM(p.amount), 0) as balance
FROM Customer c
LEFT JOIN Invoice i ON c.id = i.customerId AND i.deletedAt IS NULL
LEFT JOIN Payment p ON i.id = p.invoiceId AND p.deletedAt IS NULL
GROUP BY c.id, c.name;
```

#### 4.2.2 Service Integration

```javascript
// backend/services/financial/customers.service.js

async getCustomerBalance(customerId) {
  const [result] = await db.query(`
    SELECT * FROM CustomerBalance WHERE customerId = ?
  `, [customerId]);

  return result[0] || {
    customerId,
    totalInvoiced: 0,
    totalPaid: 0,
    balance: 0
  };
}

async getCustomerInvoices(customerId, filters = {}) {
  return await invoicesRepository.findByCustomer(customerId, filters);
}

async getCustomerPayments(customerId, filters = {}) {
  return await paymentsRepository.findByCustomer(customerId, filters);
}
```

#### 4.2.3 API Endpoints

```javascript
// Get customer balance
GET /api/customers/:id/balance

// Get customer invoices
GET /api/customers/:id/invoices

// Get customer payments
GET /api/customers/:id/payments
```

---

## 5. Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Companies Module

### 5.1 Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ

**Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯:**
- âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±
- âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø¬Ù…Ø¹Ø© Ù„Ù„Ø´Ø±ÙƒØ§Øª
- âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù…Ø¬Ù…Ø¹Ø©

### 5.2 Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨

#### 5.2.1 Database Schema

```sql
-- Add companyId to Invoice
ALTER TABLE Invoice
  ADD COLUMN companyId INT(11) NULL AFTER customerId,
  ADD INDEX idx_invoice_company (companyId),
  ADD FOREIGN KEY (companyId) REFERENCES Company(id) ON DELETE SET NULL;

-- Create view for company balance
CREATE VIEW CompanyBalance AS
SELECT 
  co.id as companyId,
  co.name as companyName,
  COALESCE(SUM(i.totalAmount), 0) as totalInvoiced,
  COALESCE(SUM(p.amount), 0) as totalPaid,
  COALESCE(SUM(i.totalAmount), 0) - COALESCE(SUM(p.amount), 0) as balance
FROM Company co
LEFT JOIN Invoice i ON co.id = i.companyId AND i.deletedAt IS NULL
LEFT JOIN Payment p ON i.id = p.invoiceId AND p.deletedAt IS NULL
GROUP BY co.id, co.name;
```

#### 5.2.2 Service Integration

```javascript
// backend/services/financial/companies.service.js

async getCompanyBalance(companyId) {
  const [result] = await db.query(`
    SELECT * FROM CompanyBalance WHERE companyId = ?
  `, [companyId]);

  return result[0] || {
    companyId,
    totalInvoiced: 0,
    totalPaid: 0,
    balance: 0
  };
}

async getCompanyInvoices(companyId, filters = {}) {
  return await invoicesRepository.findByCompany(companyId, filters);
}
```

---

## 6. Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Branches Module

### 6.1 Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ

**Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯:**
- âœ… `Expense.branchId` - Ø±Ø¨Ø· Ø§Ù„Ù†ÙÙ‚Ø§Øª Ø¨Ø§Ù„ÙØ±ÙˆØ¹
- âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª

### 6.2 Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨

#### 6.2.1 Database Schema

```sql
-- Add branchId to Invoice
ALTER TABLE Invoice
  ADD COLUMN branchId INT(11) NULL AFTER companyId,
  ADD INDEX idx_invoice_branch (branchId),
  ADD FOREIGN KEY (branchId) REFERENCES Branch(id) ON DELETE SET NULL;

-- Add branchId to Payment
ALTER TABLE Payment
  ADD COLUMN branchId INT(11) NULL AFTER invoiceId,
  ADD INDEX idx_payment_branch (branchId),
  ADD FOREIGN KEY (branchId) REFERENCES Branch(id) ON DELETE SET NULL;
```

#### 6.2.2 Service Integration

```javascript
// backend/services/financial/branches.service.js

async getBranchFinancialSummary(branchId, dateFrom, dateTo) {
  const [expenses] = await db.query(`
    SELECT SUM(amount) as totalExpenses
    FROM Expense
    WHERE branchId = ? AND date BETWEEN ? AND ? AND deletedAt IS NULL
  `, [branchId, dateFrom, dateTo]);

  const [invoices] = await db.query(`
    SELECT 
      SUM(totalAmount) as totalInvoiced,
      SUM(CASE WHEN status = 'paid' THEN totalAmount ELSE 0 END) as totalPaid
    FROM Invoice
    WHERE branchId = ? AND issueDate BETWEEN ? AND ? AND deletedAt IS NULL
  `, [branchId, dateFrom, dateTo]);

  return {
    expenses: expenses[0].totalExpenses || 0,
    invoiced: invoices[0].totalInvoiced || 0,
    paid: invoices[0].totalPaid || 0,
    profit: (invoices[0].totalPaid || 0) - (expenses[0].totalExpenses || 0)
  };
}
```

---

## 7. Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Users Module

### 7.1 Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ

**Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯:**
- âœ… `createdBy` ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
- âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Audit Trail Ø´Ø§Ù…Ù„

### 7.2 Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨

#### 7.2.1 Audit Logging

```javascript
// backend/services/financial/auditLog.service.js

async logFinancialAction(action, entityType, entityId, userId, changes) {
  await auditLogRepository.create({
    action,
    entityType,
    entityId,
    userId,
    module: 'financial',
    changes: JSON.stringify(changes),
    ipAddress: req.ip,
    userAgent: req.get('user-agent'),
    createdAt: new Date()
  });
}
```

---

## 8. Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Notifications Module

### 8.1 Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨

#### 8.1.1 Notification Events

```javascript
// When invoice is created
notificationService.send({
  type: 'invoice_created',
  userId: invoice.customerId,
  title: 'ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©',
  message: `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© ${invoice.invoiceNumber}`,
  data: { invoiceId: invoice.id }
});

// When invoice is overdue
notificationService.send({
  type: 'invoice_overdue',
  userId: invoice.customerId,
  title: 'ÙØ§ØªÙˆØ±Ø© Ù…ØªØ£Ø®Ø±Ø©',
  message: `ÙØ§ØªÙˆØ±Ø© ${invoice.invoiceNumber} Ù…ØªØ£Ø®Ø±Ø©`,
  data: { invoiceId: invoice.id, daysOverdue: 5 }
});

// When payment is received
notificationService.send({
  type: 'payment_received',
  userId: invoice.customerId,
  title: 'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¯ÙØ¹Ø©',
  message: `ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¯ÙØ¹Ø© ${payment.amount} Ù„Ù„ÙØ§ØªÙˆØ±Ø© ${invoice.invoiceNumber}`,
  data: { paymentId: payment.id, invoiceId: invoice.id }
});
```

---

## 9. Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Reports Module

### 9.1 Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨

#### 9.1.1 Financial Reports

```javascript
// backend/services/financial/financialReports.service.js

async getProfitLossReport(dateFrom, dateTo, branchId = null) {
  // Get revenue (paid invoices)
  const revenue = await invoicesRepository.getRevenue(dateFrom, dateTo, branchId);
  
  // Get expenses
  const expenses = await expensesRepository.getTotal(dateFrom, dateTo, branchId);
  
  // Get COGS (Cost of Goods Sold)
  const cogs = await inventoryService.getCOGS(dateFrom, dateTo, branchId);
  
  return {
    revenue,
    expenses,
    cogs,
    grossProfit: revenue - cogs,
    netProfit: revenue - expenses - cogs
  };
}

async getCashFlowReport(dateFrom, dateTo, branchId = null) {
  // Get cash inflows (payments)
  const inflows = await paymentsRepository.getTotal(dateFrom, dateTo, branchId);
  
  // Get cash outflows (expenses)
  const outflows = await expensesRepository.getTotal(dateFrom, dateTo, branchId);
  
  return {
    inflows,
    outflows,
    netCashFlow: inflows - outflows
  };
}
```

---

## ğŸ“š Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹

- [Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ](./01_OVERVIEW_AND_CURRENT_STATE.md)
- [Ø®Ø·Ø© Backend](./02_BACKEND_DEVELOPMENT_PLAN.md)
- [Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ°](./07_IMPLEMENTATION_PLAN.md)

---

**Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:** 2025-01-27

