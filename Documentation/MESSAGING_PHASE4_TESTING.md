# ๐งช ุฏููู ุงุฎุชุจุงุฑ ุงููุฑุญูุฉ 4: ุงูุฃุชูุชุฉ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูุฏููู ูุดุฑุญ ููููุฉ ุงุฎุชุจุงุฑ ูุธุงู ุงูุฃุชูุชุฉ ูู ุงููุฑุญูุฉ 4.

**ุชุงุฑูุฎ ุงูุฅูุดุงุก:** 2025-01-12

---

## โ ุงููุชุทูุจุงุช

1. โ ุชู ุฅููุงู ุงููุฑุญูุฉ 4
2. โ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุญุฏุซุฉ
3. โ ุงูุณูุฑูุฑ ูุนูู
4. โ ุฅุนุฏุงุฏุงุช ุงููุฑุงุณูุฉ ููุฌูุฏุฉ

---

## ๐งช ุงูุงุฎุชุจุงุฑุงุช

### 1. ุงุฎุชุจุงุฑ ุฅุนุฏุงุฏุงุช ุงูุฃุชูุชุฉ ูู ุงููุฑููุช ุฅูุฏ

**ุงูุฎุทูุงุช:**
1. ุงูุชุญ ุงููุชุตูุญ: `http://localhost:3000`
2. ุงุฐูุจ ุฅูู: `/settings` โ ูุณู "ุฅุนุฏุงุฏุงุช ุงููุฑุงุณูุฉ"
3. ุงุจุญุซ ุนู ูุณู "ุฅุนุฏุงุฏุงุช ุงูุฃุชูุชุฉ (Automation)"
4. ุชุญูู ูู:
   - โ Checkbox "ุชูุนูู ุงูุฃุชูุชุฉ"
   - โ Checkboxes ูููููุงุช ุงูุงูุชุฑุงุถูุฉ (ูุงุชุณุงุจ + Email)
   - โ Checkbox "ุฅุดุนุงุฑ ุนูุฏ ุฅูุดุงุก ูุงุชูุฑุฉ ุฌุฏูุฏุฉ"
   - โ ูุงุฆูุฉ ุจุงูุฅุดุนุงุฑุงุช ุงูุชููุงุฆูุฉ ุงููุชุงุญุฉ

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ูุณู ุงูุฃุชูุชุฉ ูุธูุฑ ูู ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช
- โ ูููู ุชูุนูู/ุชุนุทูู ุงูุฃุชูุชุฉ
- โ ูููู ุงุฎุชูุงุฑ ุงููููุงุช ุงูุงูุชุฑุงุถูุฉ
- โ ูููู ุญูุธ ุงูุฅุนุฏุงุฏุงุช

---

### 2. ุงุฎุชุจุงุฑ ุฅุดุนุงุฑุงุช ุทูุจุงุช ุงูุฅุตูุงุญ

#### ุงุฎุชุจุงุฑ 2.1: ุชุบููุฑ ุญุงูุฉ ุทูุจ ุฅุตูุงุญ

**ุงูุฎุทูุงุช:**
1. ุงุฐูุจ ุฅูู: `/repairs`
2. ุงุฎุชุฑ ุฃู ุทูุจ ุฅุตูุงุญ
3. ุบููุฑ ุงูุญุงูุฉ ุฅูู "ุชู ุงูุงุณุชูุงู" (RECEIVED)
4. ุชุญูู ูู:
   - โ ุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ุชููุงุฆู
   - โ ุงูุณุฌู ูู `MessagingLog`

**API Test:**
```bash
PATCH /api/repairs/:id/status
{
  "status": "received"
}
```

**ุงูุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
```sql
SELECT * FROM MessagingLog 
WHERE entityType = 'repair' 
AND entityId = :repairId
ORDER BY createdAt DESC
LIMIT 1;
```

---

#### ุงุฎุชุจุงุฑ 2.2: ุญุงูุงุช ูุฎุชููุฉ

**ุงูุญุงูุงุช ุงููุทููุจุฉ:**
- โ `RECEIVED` โ ุฅุดุนุงุฑ "ุชู ุงุณุชูุงู ุงูุทูุจ"
- โ `INSPECTION` โ ุฅุดุนุงุฑ "ุชู ุงูุชุดุฎูุต"
- โ `READY_FOR_DELIVERY` โ ุฅุดุนุงุฑ "ุงูุชูู ุงูุฅุตูุงุญ"
- โ `READY_FOR_PICKUP` โ ุฅุดุนุงุฑ "ุฌุงูุฒ ููุงุณุชูุงู"

---

### 3. ุงุฎุชุจุงุฑ ุฅุดุนุงุฑุงุช ุงูููุงุชูุฑ

**ุงูุฎุทูุงุช:**
1. ุงุฐูุจ ุฅูู: `/invoices`
2. ุฃูุดุฆ ูุงุชูุฑุฉ ุฌุฏูุฏุฉ
3. ุชุญูู ูู:
   - โ ุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ุชููุงุฆู (ุฅุฐุง ูุงู ููุนูุงู)
   - โ ุงูุณุฌู ูู `MessagingLog`

**API Test:**
```bash
POST /api/invoices
{
  "customerId": 1,
  "totalAmount": 1000,
  ...
}
```

**ุงูุชุญูู:**
```sql
SELECT * FROM MessagingLog 
WHERE entityType = 'invoice' 
AND entityId = :invoiceId
ORDER BY createdAt DESC
LIMIT 1;
```

---

### 4. ุงุฎุชุจุงุฑ ุชุฐููุฑุงุช ุงูุฏูุน

#### ุงุฎุชุจุงุฑ 4.1: ุชุฐููุฑุงุช ุงููุชุฃุฎุฑุฉ

**ุงูุฎุทูุงุช:**
1. ุชุฃูุฏ ูู ูุฌูุฏ ููุงุชูุฑ ูุชุฃุฎุฑุฉ (dueDate ูู ุงููุงุถู)
2. ุดุบูู ุงูุณูุฑูุจุช:
   ```bash
   node backend/scripts/test-automation.js
   ```
3. ุฃู ุงุณุชุฏุนู ุงูุฏุงูุฉ ูุจุงุดุฑุฉ:
   ```javascript
   const automationService = require('./services/automation.service');
   await automationService.checkOverduePayments();
   ```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ูุชู ุฅุฑุณุงู ุชุฐููุฑุงุช ููููุงุชูุฑ ุงููุชุฃุฎุฑุฉ
- โ ูุง ูุชู ุฅุฑุณุงู ุชุฐููุฑ ุฅุฐุง ุชู ุฅุฑุณุงู ูุงุญุฏ ูู ุขุฎุฑ 24 ุณุงุนุฉ

---

#### ุงุฎุชุจุงุฑ 4.2: ุชุฐููุฑุงุช ูุจู ุงูุงุณุชุญูุงู

**ุงูุฎุทูุงุช:**
1. ุชุฃูุฏ ูู ูุฌูุฏ ููุงุชูุฑ ูุณุชุญูุฉ ุฎูุงู 3 ุฃูุงู
2. ุดุบูู:
   ```javascript
   await automationService.sendPaymentReminders();
   ```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ูุชู ุฅุฑุณุงู ุชุฐููุฑุงุช ููููุงุชูุฑ ุงููุณุชุญูุฉ ุฎูุงู 3 ุฃูุงู

---

### 5. ุงุฎุชุจุงุฑ Cron Jobs

**ุงูุฎุทูุงุช:**
1. ุชุฃูุฏ ูู ุฃู ุงูุณูุฑูุฑ ูุนูู
2. ุชุญูู ูู Console:
   ```
   [CRON] Starting messaging cron jobs...
   [CRON] โ Overdue payments job started (daily at 9 AM)
   [CRON] โ Payment reminders job started (daily at 10 AM)
   ```

**ุงุฎุชุจุงุฑ ูุฏูู:**
```javascript
const messagingCronJobs = require('./jobs/messagingCronJobs');

// ุชุดุบูู ูุฏูู
await automationService.checkOverduePayments();
await automationService.sendPaymentReminders();
```

---

## ๐ ุงูุชุญูู ูู ุงูุณุฌูุงุช

### ุนุฑุถ ุฌููุน ุงูุฑุณุงุฆู ุงููุฑุณูุฉ:

```sql
SELECT 
  id,
  entityType,
  entityId,
  channel,
  status,
  recipient,
  sentAt,
  errorMessage
FROM MessagingLog
ORDER BY createdAt DESC
LIMIT 20;
```

### ุฅุญุตุงุฆูุงุช:

```sql
SELECT 
  channel,
  status,
  COUNT(*) as count
FROM MessagingLog
GROUP BY channel, status;
```

---

## โ๏ธ ุงููุดุงูู ุงููุญุชููุฉ

### ุงููุดููุฉ 1: ุงูุฃุชูุชุฉ ูุง ุชุนูู

**ุงูุชุญูู:**
1. ุชุญูู ูู ุฅุนุฏุงุฏุงุช ุงูุฃุชูุชุฉ:
   ```sql
   SELECT value FROM SystemSetting WHERE `key` = 'messaging_settings';
   ```
2. ุชุฃูุฏ ูู `automation.enabled = true`

**ุงูุญู:**
- ุชูุนูู ุงูุฃุชูุชุฉ ูู ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช
- ุฃู ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช ูุจุงุดุฑุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

---

### ุงููุดููุฉ 2: ูุง ูุชู ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช

**ุงูุชุญูู:**
1. ุชุญูู ูู ูุฌูุฏ ุจูุงูุงุช ุงูุนููู (phone/email)
2. ุชุญูู ูู ุชูุนูู ุงููููุงุช (WhatsApp/Email)
3. ุชุญูู ูู ุงูุณุฌูุงุช ูู `MessagingLog`

**ุงูุญู:**
- ุฅุถุงูุฉ ุจูุงูุงุช ุงูุนููู (phone/email)
- ุชูุนูู ุงููููุงุช ูู ุงูุฅุนุฏุงุฏุงุช

---

### ุงููุดููุฉ 3: Cron Jobs ูุง ุชุนูู

**ุงูุชุญูู:**
1. ุชุญูู ูู Console ุนูุฏ ุจุฏุก ุงูุณูุฑูุฑ
2. ุชุญูู ูู ุฃู `node-cron` ูุซุจุช:
   ```bash
   npm list node-cron
   ```

**ุงูุญู:**
- ุชุซุจูุช `node-cron`:
   ```bash
   npm install node-cron
   ```
- ุฅุนุงุฏุฉ ุชุดุบูู ุงูุณูุฑูุฑ

---

## ๐ ุณูุฑูุจุช ุงูุงุฎุชุจุงุฑ ุงูุดุงูู

**ุงูููู:** `backend/scripts/test-automation.js`

**ุงูุงุณุชุฎุฏุงู:**
```bash
cd backend
node scripts/test-automation.js
```

**ุงููุชูุฌุฉ:**
- โ ุงุฎุชุจุงุฑ ุชูุนูู ุงูุฃุชูุชุฉ
- โ ุงุฎุชุจุงุฑ ุงููููุงุช ุงูุงูุชุฑุงุถูุฉ
- โ ุงุฎุชุจุงุฑ ุฅุดุนุงุฑุงุช ุทูุจุงุช ุงูุฅุตูุงุญ
- โ ุงุฎุชุจุงุฑ ุฅุดุนุงุฑุงุช ุงูููุงุชูุฑ
- โ ุงุฎุชุจุงุฑ ุชุฐููุฑุงุช ุงูุฏูุน
- โ ุนุฑุถ ุขุฎุฑ ุงูุฑุณุงุฆู ุงููุฑุณูุฉ

---

## โ ูุงุฆูุฉ ุงูุชุญูู

- [ ] ุฅุนุฏุงุฏุงุช ุงูุฃุชูุชุฉ ุชุธูุฑ ูู ุงููุฑููุช ุฅูุฏ
- [ ] ูููู ุชูุนูู/ุชุนุทูู ุงูุฃุชูุชุฉ
- [ ] ูููู ุงุฎุชูุงุฑ ุงููููุงุช ุงูุงูุชุฑุงุถูุฉ
- [ ] ุฅุดุนุงุฑุงุช ุทูุจุงุช ุงูุฅุตูุงุญ ุชุนูู
- [ ] ุฅุดุนุงุฑุงุช ุงูููุงุชูุฑ ุชุนูู
- [ ] ุชุฐููุฑุงุช ุงูุฏูุน ุงููุชุฃุฎุฑุฉ ุชุนูู
- [ ] ุชุฐููุฑุงุช ูุจู ุงูุงุณุชุญูุงู ุชุนูู
- [ ] Cron Jobs ุชุนูู
- [ ] ุงูุณุฌูุงุช ุชูุณุฌู ูู `MessagingLog`

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2025-01-12  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุงุฎุชุจุงุฑ


