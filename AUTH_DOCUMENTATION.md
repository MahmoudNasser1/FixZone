# توثيق نظام المصادقة (Authentication System Documentation)

هذا المستند يوضح تفاصيل نظام المصادقة في مشروع Fix Zone ERP، بما في ذلك المكونات الرئيسية، كيفية عملها، والخطوات التي تم اتخاذها لتطويرها.

## 1. نظرة عامة

نظام المصادقة يعتمد على JSON Web Tokens (JWT) لتأمين واجهات برمجة التطبيقات (APIs). عند تسجيل الدخول بنجاح، يتم إصدار JWT للمستخدم، والذي يجب استخدامه في جميع الطلبات اللاحقة للمسارات المحمية.

## 2. المكونات الرئيسية

*   **`backend/controllers/authController.js`**: يحتوي على منطق التعامل مع تسجيل المستخدمين (register) وتسجيل الدخول (login).
    *   يستخدم `bcryptjs` لتشفير كلمات المرور.
    *   يستخدم `jsonwebtoken` لإنشاء والتحقق من JWTs.
    *   يتفاعل مع جدول `user` في قاعدة البيانات.
*   **`backend/routes/auth.js`**: يحدد المسارات الخاصة بالمصادقة (`/api/auth/register`, `/api/auth/login`).
*   **`backend/middleware/authMiddleware.js`**: هو middleware يقوم بالتحقق من صحة JWT في رأس الطلب (`x-auth-token`) ويحمي المسارات.
*   **`backend/middleware/authorizeMiddleware.js`**: هو middleware يقوم بالتحقق من دور المستخدم المصادق عليه ويسمح أو يمنع الوصول بناءً على الأدوار المحددة.
*   **قاعدة البيانات (`user` table)**: تحتوي على معلومات المستخدمين (id, name, email, password, roleId).
*   **`backend/controllers/userController.js`**: يحتوي على منطق التعامل مع إدارة المستخدمين والأدوار (جلب، تحديث، حذف المستخدمين، جلب الأدوار).
*   **`backend/routes/users.js`**: يحدد المسارات الخاصة بإدارة المستخدمين (`/api/users`).
*   **`backend/routes/roles.js`**: يحدد المسارات الخاصة بإدارة الأدوار (`/api/roles`).

## 3. تدفق المصادقة (Authentication Flow)

1.  **تسجيل المستخدم (Register)**:
    *   يرسل المستخدم طلب `POST` إلى `/api/auth/register` مع `name`, `email`, `password`, و `roleId`.
    *   يتم التحقق مما إذا كان المستخدم موجودًا بالفعل.
    *   يتم تشفير كلمة المرور باستخدام `bcrypt`.
    *   يتم حفظ المستخدم الجديد في جدول `user`.
    *   يتم إرجاع رسالة نجاح `201 Created`.

2.  **تسجيل الدخول (Login)**:
    *   يرسل المستخدم طلب `POST` إلى `/api/auth/login` مع `name` و `password`.
    *   يتم التحقق من وجود المستخدم في قاعدة البيانات.
    *   يتم مقارنة كلمة المرور المقدمة مع كلمة المرور المشفرة المخزنة باستخدام `bcrypt.compare`.
    *   إذا كانت بيانات الاعتماد صحيحة، يتم إنشاء JWT يحتوي على `id` و `roleId` للمستخدم.
    *   يتم إرجاع الـ JWT في الاستجابة `200 OK`.

3.  **الوصول إلى المسارات المحمية (Accessing Protected Routes)**:
    *   عند محاولة الوصول إلى مسار محمي (مثل `/api/auth/protected` الذي سيتم إنشاؤه)، يجب على المستخدم تضمين الـ JWT الذي حصل عليه من عملية تسجيل الدخول في رأس الطلب `x-auth-token`.
    *   يقوم `authMiddleware` باعتراض الطلب، والتحقق من صحة الـ JWT.
    *   إذا كان الـ JWT صالحًا، يتم فك تشفيره وتخزين بيانات المستخدم في `req.user`، ويسمح للطلب بالمرور.
    *   إذا كان الـ JWT غير صالح أو مفقود، يتم رفض الطلب برسالة `401 Unauthorized`.

## 4. الخطوات المنجزة

*   تم تنفيذ وظائف التسجيل وتسجيل الدخول في `authController.js`.
*   تم تصحيح أسماء الأعمدة (`id` بدلاً من `UserID`, `name` بدلاً من `username`) لتتوافق مع `fixzone_erp_full_schema.sql`.
*   تم إنشاء `authMiddleware.js` للتحقق من JWT.
*   تم إنشاء `authorizeMiddleware.js` للتحقق من صلاحيات الأدوار.

## 5. الخطوات القادمة

*   تم تنفيذ الجزء الخلفي (Backend) من API لتتبع نشاط المستخدمين (تسجيل الدخول، تحديث المستخدم، حذف المستخدم).
*   نقل `JWT_SECRET` إلى متغيرات البيئة لتعزيز الأمان.
*   تطوير وحدات أخرى مثل طلبات الإصلاح (Repair Requests) وإدارة علاقات العملاء (CRM).

## 6. إدارة المستخدمين والأدوار (User and Role Management)

تم الآن تنفيذ واجهات برمجة التطبيقات (APIs) لإدارة المستخدمين والأدوار. هذه المسارات محمية وتتطلب مصادقة (JWT) وصلاحيات إدارية (RoleID 1).

*   **جلب جميع المستخدمين**: `GET /api/users` (يتطلب دور المدير)
*   **جلب مستخدم بواسطة ID**: `GET /api/users/:id` (يتطلب دور المدير)
*   **تحديث مستخدم**: `PUT /api/users/:id` (يتطلب دور المدير)
*   **حذف مستخدم (حذف ناعم)**: `DELETE /api/users/:id` (يتطلب دور المدير)
*   **جلب جميع الأدوار**: `GET /api/roles` (يتطلب دور المدير)
